
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A FastAPI service for fetching financial data from various sources">
      
      
        <meta name="author" content="Harvey Tseng">
      
      
        <link rel="canonical" href="https://verdenroz.github.io/finance-query/development/architecture/">
      
      
        <link rel="prev" href="../contributing/">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>Architecture - Finance Query</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="teal">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#financequery-api-architecture" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Finance Query" class="md-header__button md-logo" aria-label="Finance Query" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Finance Query
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Architecture
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="teal"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="teal" data-md-color-accent="teal"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/Verdenroz/finance-query" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    Verdenroz/finance-query
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Finance Query" class="md-nav__button md-logo" aria-label="Finance Query" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Finance Query
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Verdenroz/finance-query" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg>
  </div>
  <div class="md-source__repository">
    Verdenroz/finance-query
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Deployment
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/health/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Health Check
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/hours/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Market Hours
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/quotes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quotes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/historical/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Historical Data
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/movers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Market Movers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/news/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    News
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/indices/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Indices
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/sectors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sectors
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/search/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Search
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/indicators/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Technical Indicators
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api/stream/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SSE Stream
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Websockets
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Websockets
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../websockets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Overview
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../websockets/profile/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Profile
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../websockets/quotes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quotes
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../websockets/market/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Market
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../websockets/hours/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Hours
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Development
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Development
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../contributing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Contributing
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Architecture
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-overview" class="md-nav__link">
    <span class="md-ellipsis">
      1. Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-core-components" class="md-nav__link">
    <span class="md-ellipsis">
      2. Core Components
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Core Components">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-fastapi-application-mainpy" class="md-nav__link">
    <span class="md-ellipsis">
      2.1. FastAPI Application (main.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-health-checks-mainpy" class="md-nav__link">
    <span class="md-ellipsis">
      2.2. Health Checks (main.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-models-and-routers" class="md-nav__link">
    <span class="md-ellipsis">
      2.3. Models and Routers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.3. Models and Routers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pydantic-models-srcmodels" class="md-nav__link">
    <span class="md-ellipsis">
      Pydantic Models (src/models)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#routers-srcroutes" class="md-nav__link">
    <span class="md-ellipsis">
      Routers (src/routes)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-routes-models-and-services-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      3. Routes, Models, and Services Architecture
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Routes, Models, and Services Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-models-srcmodels" class="md-nav__link">
    <span class="md-ellipsis">
      3.1. Models (src/models)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-routes-srcroutes" class="md-nav__link">
    <span class="md-ellipsis">
      3.2. Routes (src/routes)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-services-srcservices" class="md-nav__link">
    <span class="md-ellipsis">
      3.3. Services (src/services)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.3. Services (src/services)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#service-organization" class="md-nav__link">
    <span class="md-ellipsis">
      Service Organization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-source-strategy-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-Source Strategy Pattern
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34-caching-strategy-srcutilscachepy" class="md-nav__link">
    <span class="md-ellipsis">
      3.4. Caching Strategy (src/utils/cache.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35-retry-mechanism-srcutilsretrypy" class="md-nav__link">
    <span class="md-ellipsis">
      3.5. Retry Mechanism (src/utils/retry.py)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-dependency-injection-srcutilsdependenciespy" class="md-nav__link">
    <span class="md-ellipsis">
      4. Dependency Injection (src/utils/dependencies.py)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-yahoo-authentication-srcutilsyahoo_authpy" class="md-nav__link">
    <span class="md-ellipsis">
      5. Yahoo Authentication (src/utils/yahoo_auth.py)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-http-clients" class="md-nav__link">
    <span class="md-ellipsis">
      6. HTTP Clients
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. HTTP Clients">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-curlfetchclient-srcclientsfetch_clientpy" class="md-nav__link">
    <span class="md-ellipsis">
      6.1. CurlFetchClient (src/clients/fetch_client.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-yahoofinanceclient-srcclientsyahoo_clientpy" class="md-nav__link">
    <span class="md-ellipsis">
      6.2. YahooFinanceClient (src/clients/yahoo_client.py)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-websocket-connection-management" class="md-nav__link">
    <span class="md-ellipsis">
      7. WebSocket Connection Management
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. WebSocket Connection Management">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71-connectionmanager-srcconnectionsconnection_managerpy" class="md-nav__link">
    <span class="md-ellipsis">
      7.1. ConnectionManager (src/connections/connection_manager.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-redisconnectionmanager-srcconnectionsredis_connection_managerpy" class="md-nav__link">
    <span class="md-ellipsis">
      7.2. RedisConnectionManager (src/connections/redis_connection_manager.py)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-rate-limiting-and-security-srcsecurity" class="md-nav__link">
    <span class="md-ellipsis">
      8. Rate Limiting and Security (src/security/)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. Rate Limiting and Security (src/security/)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-securityconfig-srcsecurityrate_limit_managerpy" class="md-nav__link">
    <span class="md-ellipsis">
      8.1. SecurityConfig (src/security/rate_limit_manager.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82-ratelimitmanager-srcsecurityrate_limit_managerpy" class="md-nav__link">
    <span class="md-ellipsis">
      8.2. RateLimitManager (src/security/rate_limit_manager.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#83-ratelimitmiddleware-srcsecurityrate_limit_middlewarepy" class="md-nav__link">
    <span class="md-ellipsis">
      8.3. RateLimitMiddleware (src/security/rate_limit_middleware.py)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-authentication-srcutilsyahoo_authpy" class="md-nav__link">
    <span class="md-ellipsis">
      9. Authentication (src/utils/yahoo_auth.py)
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-overview" class="md-nav__link">
    <span class="md-ellipsis">
      1. Overview
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-core-components" class="md-nav__link">
    <span class="md-ellipsis">
      2. Core Components
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Core Components">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-fastapi-application-mainpy" class="md-nav__link">
    <span class="md-ellipsis">
      2.1. FastAPI Application (main.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-health-checks-mainpy" class="md-nav__link">
    <span class="md-ellipsis">
      2.2. Health Checks (main.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-models-and-routers" class="md-nav__link">
    <span class="md-ellipsis">
      2.3. Models and Routers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.3. Models and Routers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pydantic-models-srcmodels" class="md-nav__link">
    <span class="md-ellipsis">
      Pydantic Models (src/models)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#routers-srcroutes" class="md-nav__link">
    <span class="md-ellipsis">
      Routers (src/routes)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-routes-models-and-services-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      3. Routes, Models, and Services Architecture
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Routes, Models, and Services Architecture">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-models-srcmodels" class="md-nav__link">
    <span class="md-ellipsis">
      3.1. Models (src/models)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-routes-srcroutes" class="md-nav__link">
    <span class="md-ellipsis">
      3.2. Routes (src/routes)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-services-srcservices" class="md-nav__link">
    <span class="md-ellipsis">
      3.3. Services (src/services)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.3. Services (src/services)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#service-organization" class="md-nav__link">
    <span class="md-ellipsis">
      Service Organization
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multi-source-strategy-pattern" class="md-nav__link">
    <span class="md-ellipsis">
      Multi-Source Strategy Pattern
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34-caching-strategy-srcutilscachepy" class="md-nav__link">
    <span class="md-ellipsis">
      3.4. Caching Strategy (src/utils/cache.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35-retry-mechanism-srcutilsretrypy" class="md-nav__link">
    <span class="md-ellipsis">
      3.5. Retry Mechanism (src/utils/retry.py)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-dependency-injection-srcutilsdependenciespy" class="md-nav__link">
    <span class="md-ellipsis">
      4. Dependency Injection (src/utils/dependencies.py)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-yahoo-authentication-srcutilsyahoo_authpy" class="md-nav__link">
    <span class="md-ellipsis">
      5. Yahoo Authentication (src/utils/yahoo_auth.py)
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-http-clients" class="md-nav__link">
    <span class="md-ellipsis">
      6. HTTP Clients
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. HTTP Clients">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-curlfetchclient-srcclientsfetch_clientpy" class="md-nav__link">
    <span class="md-ellipsis">
      6.1. CurlFetchClient (src/clients/fetch_client.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-yahoofinanceclient-srcclientsyahoo_clientpy" class="md-nav__link">
    <span class="md-ellipsis">
      6.2. YahooFinanceClient (src/clients/yahoo_client.py)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-websocket-connection-management" class="md-nav__link">
    <span class="md-ellipsis">
      7. WebSocket Connection Management
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. WebSocket Connection Management">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71-connectionmanager-srcconnectionsconnection_managerpy" class="md-nav__link">
    <span class="md-ellipsis">
      7.1. ConnectionManager (src/connections/connection_manager.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-redisconnectionmanager-srcconnectionsredis_connection_managerpy" class="md-nav__link">
    <span class="md-ellipsis">
      7.2. RedisConnectionManager (src/connections/redis_connection_manager.py)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-rate-limiting-and-security-srcsecurity" class="md-nav__link">
    <span class="md-ellipsis">
      8. Rate Limiting and Security (src/security/)
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. Rate Limiting and Security (src/security/)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-securityconfig-srcsecurityrate_limit_managerpy" class="md-nav__link">
    <span class="md-ellipsis">
      8.1. SecurityConfig (src/security/rate_limit_manager.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82-ratelimitmanager-srcsecurityrate_limit_managerpy" class="md-nav__link">
    <span class="md-ellipsis">
      8.2. RateLimitManager (src/security/rate_limit_manager.py)
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#83-ratelimitmiddleware-srcsecurityrate_limit_middlewarepy" class="md-nav__link">
    <span class="md-ellipsis">
      8.3. RateLimitMiddleware (src/security/rate_limit_middleware.py)
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-authentication-srcutilsyahoo_authpy" class="md-nav__link">
    <span class="md-ellipsis">
      9. Authentication (src/utils/yahoo_auth.py)
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="financequery-api-architecture">FinanceQuery API Architecture<a class="headerlink" href="#financequery-api-architecture" title="Permanent link">&para;</a></h1>
<h2 id="1-overview">1. Overview<a class="headerlink" href="#1-overview" title="Permanent link">&para;</a></h2>
<p>FinanceQuery is a FastAPI-based application designed to provide financial data by scraping web sources and interacting with Yahoo Finance's unofficial API. It offers RESTful endpoints for various financial data points and WebSocket support for real-time data streaming. The architecture emphasizes modularity, asynchronous operations, and resilience.</p>
<h2 id="2-core-components">2. Core Components<a class="headerlink" href="#2-core-components" title="Permanent link">&para;</a></h2>
<h3 id="21-fastapi-application-mainpy">2.1. FastAPI Application (<code>main.py</code>)<a class="headerlink" href="#21-fastapi-application-mainpy" title="Permanent link">&para;</a></h3>
<p>The core of the application is a FastAPI instance.
- <strong>Initialization</strong>: Sets up metadata like title, version, description, server URLs, contact, and license information.</p>
<ul>
<li>
<p><strong>Lifespan Management</strong>: A <code>lifespan</code> asynchronous context manager handles the initialization and cleanup of shared resources:</p>
<ul>
<li><code>fastapi_injectable</code> registration.</li>
<li>Shared <code>curl_cffi.requests.Session</code> for HTTP requests.</li>
<li><code>YahooAuthManager</code> instance for managing Yahoo Finance authentication.</li>
<li>Optional proxy setup (<code>PROXY_URL</code>, <code>USE_PROXY</code>).</li>
<li>Optional Redis client (<code>REDIS_URL</code>) for caching and WebSocket message brokering.</li>
<li>WebSocket <code>ConnectionManager</code> (defaults to in-memory, or <code>RedisConnectionManager</code> if Redis is enabled).</li>
<li>Primes Yahoo authentication on startup for faster initial user requests.</li>
<li>Ensures cleanup of resources (exit stacks, connection manager, proxy whitelist, Redis connection) on shutdown.</li>
</ul>
</li>
<li>
<p><strong>Middleware</strong>:</p>
<ul>
<li><code>CORSMiddleware</code>: Configured to allow all origins, methods, and headers, and exposes rate limit headers.</li>
<li><code>RequestContextMiddleware</code>: Makes the <code>Request</code> or <code>WebSocket</code> object accessible throughout the application via a context variable. This is crucial for dependency injection and accessing request-specific state.</li>
<li><code>RateLimitMiddleware</code>: (Optional, enabled by <code>USE_SECURITY</code> env var) Provides rate limiting capabilities.</li>
</ul>
</li>
<li>
<p><strong>Error Handling</strong>:</p>
<ul>
<li>A custom exception handler for <code>RequestValidationError</code> formats Pydantic validation errors into a more user-friendly JSON structure.</li>
</ul>
</li>
<li>
<p><strong>Routing</strong>:</p>
<ul>
<li>Includes various routers for different API functionalities (e.g., quotes, historical prices, news, WebSockets). Routers are typically prefixed with <code>/v1</code>. Each router groups related endpoints and utilizes Pydantic models for request and response validation and serialization.</li>
</ul>
</li>
<li>
<p><strong>Deployment</strong>:</p>
<ul>
<li><code>Mangum</code> adapter is used to allow deployment as an AWS Lambda function.</li>
</ul>
</li>
</ul>
<h3 id="22-health-checks-mainpy">2.2. Health Checks (<code>main.py</code>)<a class="headerlink" href="#22-health-checks-mainpy" title="Permanent link">&para;</a></h3>
<ul>
<li><strong><code>/ping</code></strong>: A simple endpoint to check if the server is alive and responding. Returns status and current timestamp.</li>
<li><strong><code>/health</code></strong>: A detailed health check endpoint that verifies:<ul>
<li>Basic API health.</li>
<li>Redis connectivity and latency (if configured).</li>
<li>Status of various internal services by making sample calls (e.g., fetching indices, market movers, news, quotes). Reports success/failure for each service.</li>
</ul>
</li>
</ul>
<h3 id="23-models-and-routers">2.3. Models and Routers<a class="headerlink" href="#23-models-and-routers" title="Permanent link">&para;</a></h3>
<h4 id="pydantic-models-srcmodels">Pydantic Models (<code>src/models</code>)<a class="headerlink" href="#pydantic-models-srcmodels" title="Permanent link">&para;</a></h4>
<p>Pydantic models are extensively used throughout the application, primarily defined in <code>src/models.py</code> (or similar modules within a <code>models</code> directory). Their roles include:</p>
<ul>
<li><strong>Data Validation</strong>: Defining the expected structure, data types, and validation rules for incoming request data (path parameters, query parameters, request bodies). FastAPI automatically uses these models to validate incoming data.</li>
<li><strong>Data Serialization</strong>: Defining the structure and data types for outgoing API responses. FastAPI uses these models to serialize response data into JSON.</li>
<li><strong>API Contract</strong>: Serving as a clear and enforceable contract for API inputs and outputs.</li>
<li><strong>OpenAPI Schema Generation</strong>: FastAPI leverages these Pydantic models to automatically generate the OpenAPI (Swagger) documentation, providing interactive API docs.</li>
<li><strong>Error Reporting</strong>: When validation fails, FastAPI (in conjunction with the custom <code>RequestValidationError</code> handler) uses the model definitions to provide detailed error messages.</li>
</ul>
<h4 id="routers-srcroutes">Routers (<code>src/routes</code>)<a class="headerlink" href="#routers-srcroutes" title="Permanent link">&para;</a></h4>
<p>The API's functionality is organized into modular routers, typically with each file in the <code>src/routes/</code> directory representing a distinct set of related endpoints or a microservice.</p>
<ul>
<li><strong>Modular Design</strong>: Each router (e.g., <code>quotes_router.py</code>, <code>historical_prices_router.py</code>) encapsulates the logic for a specific feature (e.g., fetching quotes, retrieving historical data).</li>
<li><strong>Endpoint Definition</strong>: Routers define API path operations (e.g., <code>@router.get("/symbols")</code>) along with their associated HTTP methods.</li>
<li><strong>Model Integration</strong>:<ul>
<li>Path operation functions use Pydantic models as type hints for request bodies, query parameters, and path parameters. This enables FastAPI's automatic validation.</li>
<li>The <code>response_model</code> parameter in path operation decorators is set to a Pydantic model to define the structure of the response, ensuring consistent output and enabling automatic serialization and documentation.</li>
</ul>
</li>
<li><strong>Dependency Injection</strong>: Routers utilize FastAPI's dependency injection system to obtain necessary services, clients (like <code>FinanceClient</code>), and other resources.</li>
<li><strong>Inclusion in Main App</strong>: These individual routers are then included in the main FastAPI application instance in <code>main.py</code> (e.g., <code>app.include_router(quotes_router)</code>), often with a common prefix (like <code>/v1</code>).</li>
</ul>
<h2 id="3-routes-models-and-services-architecture">3. Routes, Models, and Services Architecture<a class="headerlink" href="#3-routes-models-and-services-architecture" title="Permanent link">&para;</a></h2>
<h3 id="31-models-srcmodels">3.1. Models (<code>src/models</code>)<a class="headerlink" href="#31-models-srcmodels" title="Permanent link">&para;</a></h3>
<p>The application's data structures are defined as Pydantic models, which serve multiple purposes:</p>
<ul>
<li><strong>API Contract Definition</strong>: Models like <code>Quote</code>, <code>SimpleQuote</code>, <code>MarketIndex</code> define the structure of API responses, ensuring consistency and type safety.</li>
<li><strong>Input Validation</strong>: Models validate incoming request parameters.</li>
<li><strong>Documentation Generation</strong>: FastAPI uses these models to generate OpenAPI documentation.</li>
<li><strong>Serialization/Deserialization</strong>: Converting between Python objects and JSON for API interactions.</li>
</ul>
<h3 id="32-routes-srcroutes">3.2. Routes (<code>src/routes</code>)<a class="headerlink" href="#32-routes-srcroutes" title="Permanent link">&para;</a></h3>
<p>Routes are organized into logical modules, each responsible for a specific domain:</p>
<ul>
<li><strong><code>quotes_router</code></strong>: Endpoints for retrieving stock quotes</li>
<li><strong><code>historical_prices_router</code></strong>: Historical price data</li>
<li><strong><code>indices_router</code></strong>: Market indices data</li>
<li><strong><code>sectors_router</code></strong>: Industry sector performance</li>
<li><strong><code>movers_router</code></strong>: Market movers (gainers/losers)</li>
<li><strong><code>finance_news_router</code></strong>: Financial news</li>
<li><strong><code>search_router</code></strong>: Symbol search functionality</li>
<li><strong><code>hours_router</code></strong>: Market hours status</li>
<li><strong><code>similar_quotes_router</code></strong>: Similar securities</li>
<li><strong><code>stream_router</code></strong>: Server-sent events</li>
<li><strong><code>sockets_router</code></strong>: WebSocket connections</li>
</ul>
<p>Each router defines endpoints with:
- Path and HTTP method
- Parameter and response type definitions
- Documentation and examples
- Security requirements
- Error handling specifications</p>
<h3 id="33-services-srcservices">3.3. Services (<code>src/services</code>)<a class="headerlink" href="#33-services-srcservices" title="Permanent link">&para;</a></h3>
<p>Services implement the business logic for the API, acting as an intermediary between routes and data sources:</p>
<h4 id="service-organization">Service Organization<a class="headerlink" href="#service-organization" title="Permanent link">&para;</a></h4>
<p>Services are organized by domain (quotes, news, sectors, etc.), with each service implementing a specific data retrieval function:</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Example directory structure:
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>src/services/
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>├── quotes/
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>│   ├── fetchers/
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>│   │   ├── quote_api.py    # Primary API-based fetchers
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>│   │   └── quote_scraper.py  # Fallback web scraping implementation
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>│   ├── get_quotes.py       # Main service functions with retry logic
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>│   └── utils.py           # Helper functions for fetchers
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>├── news/
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>├── sectors/
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>└── ...
</code></pre></div></p>
</div>
<h4 id="multi-source-strategy-pattern">Multi-Source Strategy Pattern<a class="headerlink" href="#multi-source-strategy-pattern" title="Permanent link">&para;</a></h4>
<p>Many services implement a dual-fetching strategy:</p>
<ol>
<li><strong>Primary Source</strong> (usually Yahoo Finance API):</li>
<li>Faster and more reliable when available</li>
<li>
<p>Used as the first attempt</p>
</li>
<li>
<p><strong>Fallback Source</strong> (usually web scraping):</p>
</li>
<li>More resilient to API changes</li>
<li>Used when primary source fails</li>
</ol>
<p>For example, quote data has:
- <code>fetch_quotes()</code>: Primary API-based implementation in <code>quote_api.py</code>
- <code>scrape_quotes()</code>: Fallback web scraping implementation in <code>quote_scraper.py</code></p>
<p>The main service function (e.g., <code>get_quotes()</code>) uses the <code>@retry</code> decorator to attempt the primary source first and fall back to web scraping if needed.</p>
<h3 id="34-caching-strategy-srcutilscachepy">3.4. Caching Strategy (<code>src/utils/cache.py</code>)<a class="headerlink" href="#34-caching-strategy-srcutilscachepy" title="Permanent link">&para;</a></h3>
<p>The application implements a flexible caching system:</p>
<ul>
<li>
<p><strong>Cache Handlers</strong>:</p>
<ul>
<li><code>RedisCacheHandler</code>: Distributed caching when Redis is available.</li>
<li><code>MemCacheHandler</code>: Local in-memory caching when Redis is unavailable.</li>
</ul>
</li>
<li>
<p><strong>Smart Expiration</strong>:</p>
<ul>
<li>Standard TTL for normal market hours.</li>
<li>Extended TTL when market is closed (<code>market_closed_expire</code>).</li>
<li>Uses <code>MarketSchedule</code> to determine market open/closed status.</li>
</ul>
</li>
<li>
<p><strong>Cache Key Generation</strong>:</p>
<ul>
<li>Generated from function name and SHA-256 hash of arguments.</li>
<li>Excludes non-serializable objects like HTTP clients.</li>
</ul>
</li>
<li>
<p><strong>Type-Aware Deserialization</strong>:</p>
<ul>
<li>Maintains Pydantic model types after retrieval.</li>
<li>Special handling for collections (lists, dicts).</li>
</ul>
</li>
<li>
<p><strong>Environment Controls</strong>:</p>
<ul>
<li><code>BYPASS_CACHE</code> environment variable to disable caching.</li>
<li>Redis connection driven by <code>REDIS_URL</code> availability.</li>
</ul>
</li>
</ul>
<h3 id="35-retry-mechanism-srcutilsretrypy">3.5. Retry Mechanism (<code>src/utils/retry.py</code>)<a class="headerlink" href="#35-retry-mechanism-srcutilsretrypy" title="Permanent link">&para;</a></h3>
<p>A sophisticated retry decorator provides resilience for data fetching:</p>
<ul>
<li>
<p><strong>Configurable Retries</strong>:</p>
<ul>
<li>Attempts primary function up to specified number of times</li>
<li>Falls back to alternative implementation after exhausting retries</li>
</ul>
</li>
<li>
<p><strong>Intelligent Fallback</strong>:</p>
<ul>
<li>Analyzes function signatures to pass only compatible parameters</li>
<li>Logs exceptions and retry attempts</li>
</ul>
</li>
<li>
<p><strong>Error Handling</strong>:</p>
<ul>
<li>Propagates <code>HTTPException</code> directly (don't retry client errors)</li>
<li>Captures other exceptions for retry logic</li>
</ul>
</li>
</ul>
<p><strong>Usage Pattern</strong>:
  <div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="nd">@retry</span><span class="p">(</span><span class="n">fallback</span><span class="o">=</span><span class="n">scrape_quotes</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_quotes</span><span class="p">(</span><span class="n">finance_client</span><span class="p">,</span> <span class="n">symbols</span><span class="p">):</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>    <span class="c1"># Primary implementation using Yahoo Finance API</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>    <span class="k">return</span> <span class="k">await</span> <span class="n">fetch_quotes</span><span class="p">(</span><span class="n">finance_client</span><span class="p">,</span> <span class="n">symbols</span><span class="p">)</span>
</code></pre></div></p>
<h2 id="4-dependency-injection-srcutilsdependenciespy">4. Dependency Injection (<code>src/utils/dependencies.py</code>)<a class="headerlink" href="#4-dependency-injection-srcutilsdependenciespy" title="Permanent link">&para;</a></h2>
<p>The application heavily utilizes <code>fastapi_injectable</code> for managing dependencies. This promotes modularity and testability by decoupling components.</p>
<ul>
<li>
<p><strong>Shared Resources</strong>: Provides injectable dependencies for:</p>
<ul>
<li><code>RequestContext</code>: The current <code>Request</code> or <code>WebSocket</code> object, made available via <code>RequestContextMiddleware</code>.</li>
<li><code>WebsocketConnectionManager</code>: The active WebSocket connection manager, which can be either <code>ConnectionManager</code> (in-memory) or <code>RedisConnectionManager</code> (if Redis is enabled).</li>
<li><code>RedisClient</code>: The shared Redis client instance, available if <code>REDIS_URL</code> is configured.</li>
<li><code>Session</code>: The shared <code>curl_cffi.requests.Session</code> for making HTTP requests, initialized during application lifespan.</li>
<li><code>Proxy</code>: The proxy URL string, configured via environment variables.</li>
<li><code>AuthManager</code>: The shared <code>YahooAuthManager</code> instance for handling Yahoo Finance authentication.</li>
<li><code>YahooAuth</code>: A tuple of <code>(cookies, crumb)</code> obtained from <code>YahooAuthManager</code>, representing the current authentication credentials.</li>
<li><code>MarketSchedule</code>: Provides information about market open/closed status and upcoming holidays.</li>
</ul>
</li>
<li>
<p><strong>Client Abstractions</strong>:</p>
<ul>
<li><code>FetchClient</code>: An instance of <code>CurlFetchClient</code>, a general-purpose asynchronous HTTP client built on <code>curl_cffi</code>.</li>
<li><code>FinanceClient</code>: An instance of <code>YahooFinanceClient</code>, a specialized client for interacting with the Yahoo Finance API, pre-configured with authentication details.</li>
</ul>
</li>
<li>
<p><strong>Utility Functions as Dependencies</strong>:</p>
<ul>
<li><code>fetch</code>: A generic async function to perform HTTP requests using the <code>FetchClient</code>, including built-in retry logic. This is injectable and used by various services.</li>
<li><code>get_logo</code>: A utility to fetch company logos, attempting <code>logo.dev</code> first and falling back to domain icons.</li>
</ul>
</li>
<li>
<p><strong>How it Works</strong>:</p>
<ul>
<li>Dependencies are defined as functions decorated with <code>@injectable</code>.</li>
<li>FastAPI automatically resolves and injects these dependencies into route handlers and other dependent functions based on type hints.</li>
<li>For example, a route handler can request a <code>FinanceClient</code> by simply type-hinting a parameter: <code>async def my_route(client: FinanceClient): ...</code></li>
</ul>
</li>
</ul>
<h2 id="5-yahoo-authentication-srcutilsyahoo_authpy">5. Yahoo Authentication (<code>src/utils/yahoo_auth.py</code>)<a class="headerlink" href="#5-yahoo-authentication-srcutilsyahoo_authpy" title="Permanent link">&para;</a></h2>
<p>Authentication with Yahoo Finance is crucial for accessing their unofficial API. The <code>YahooAuthManager</code> class handles this process:</p>
<ul>
<li><strong>Cookie and Crumb</strong>: Yahoo Finance API requests require a valid cookie and a "crumb" (a type of CSRF token).</li>
<li><strong><code>YahooAuthManager</code></strong>:<ul>
<li>Manages fetching and caching of the cookie and crumb.</li>
<li>A single instance is created at application startup and shared.</li>
<li>Uses an <code>asyncio.Lock</code> to prevent concurrent refresh attempts.</li>
<li><strong><code>refresh()</code> method</strong>: Fetches a new cookie/crumb pair. It first tries a direct crumb endpoint. If that fails (e.g., due to consent requirements), it navigates the Yahoo consent flow to obtain a CSRF token and session ID, then uses these to get a valid crumb.</li>
<li><strong><code>get_or_refresh()</code> method</strong>: Provides the cached cookie/crumb if still valid (within <code>_MIN_REFRESH_INTERVAL</code>), otherwise triggers a refresh. This is the primary method used by dependencies.</li>
</ul>
</li>
<li><strong>Error Handling</strong>: Raises <code>YahooAuthError</code> if it fails to obtain a valid cookie/crumb after attempting all methods.</li>
<li><strong>Integration</strong>: The <code>YahooAuth</code> dependency in <code>dependencies.py</code> uses <code>YahooAuthManager</code> to provide the auth details to <code>YahooFinanceClient</code>.</li>
</ul>
<h2 id="6-http-clients">6. HTTP Clients<a class="headerlink" href="#6-http-clients" title="Permanent link">&para;</a></h2>
<p>The application uses <code>curl_cffi</code> for HTTP requests, wrapped in custom client classes for better organization and specific functionalities.</p>
<h3 id="61-curlfetchclient-srcclientsfetch_clientpy">6.1. <code>CurlFetchClient</code> (<code>src/clients/fetch_client.py</code>)<a class="headerlink" href="#61-curlfetchclient-srcclientsfetch_clientpy" title="Permanent link">&para;</a></h3>
<p>This is a general-purpose asynchronous HTTP client.</p>
<ul>
<li><strong>Core Functionality</strong>:<ul>
<li>Wraps <code>curl_cffi.requests.Session</code>.</li>
<li>Provides <code>request()</code> (synchronous) and <code>fetch()</code> (asynchronous) methods.</li>
<li>Handles common HTTP methods (GET, POST, etc.).</li>
<li>Manages default headers (e.g., User-Agent) which can be overridden.</li>
<li>Supports proxy configuration.</li>
<li>Includes basic error handling, raising <code>HTTPException</code> on request failures.</li>
</ul>
</li>
<li><strong>Asynchronous Operations</strong>: The <code>fetch()</code> method uses <code>asyncio.to_thread</code> to run synchronous <code>curl_cffi</code> calls in a separate thread, making them non-blocking for the asyncio event loop.</li>
</ul>
<h3 id="62-yahoofinanceclient-srcclientsyahoo_clientpy">6.2. <code>YahooFinanceClient</code> (<code>src/clients/yahoo_client.py</code>)<a class="headerlink" href="#62-yahoofinanceclient-srcclientsyahoo_clientpy" title="Permanent link">&para;</a></h3>
<p>This client inherits from <code>CurlFetchClient</code> and is specialized for Yahoo Finance API interactions.</p>
<ul>
<li><strong>Initialization</strong>: Takes Yahoo cookies and crumb as arguments, which are automatically injected via the <code>FinanceClient</code> dependency.</li>
<li><strong><code>_yahoo_request()</code></strong>: A private helper method that:<ul>
<li>Adds the <code>crumb</code> to request parameters.</li>
<li>Sets a specific User-Agent.</li>
<li>Handles Yahoo-specific HTTP error codes (401 for auth failure, 404 for not found, 429 for rate limits) by raising appropriate <code>HTTPException</code>.</li>
</ul>
</li>
<li><strong><code>_json()</code></strong>: A helper to make a request using <code>_yahoo_request()</code> and parse the JSON response, with error handling for parsing failures.</li>
<li><strong>API-Specific Methods</strong>: Provides methods like <code>get_quote()</code>, <code>get_simple_quotes()</code>, <code>get_chart()</code>, <code>search()</code>, and <code>get_similar_quotes()</code>, each corresponding to a specific Yahoo Finance API endpoint.</li>
</ul>
<h2 id="7-websocket-connection-management">7. WebSocket Connection Management<a class="headerlink" href="#7-websocket-connection-management" title="Permanent link">&para;</a></h2>
<p>The API supports real-time data streaming via WebSockets. Connection management is handled by classes in <code>src/connections/</code>.</p>
<h3 id="71-connectionmanager-srcconnectionsconnection_managerpy">7.1. <code>ConnectionManager</code> (<code>src/connections/connection_manager.py</code>)<a class="headerlink" href="#71-connectionmanager-srcconnectionsconnection_managerpy" title="Permanent link">&para;</a></h3>
<p>This is the default in-memory WebSocket connection manager.</p>
<ul>
<li><strong><code>active_connections</code></strong>: A dictionary mapping channel names (e.g., a stock symbol) to a list of active <code>WebSocket</code> objects subscribed to that channel.</li>
<li><strong><code>tasks</code></strong>: A dictionary mapping channel names to <code>asyncio.Task</code> objects that are responsible for fetching and broadcasting data for that channel.</li>
<li><strong><code>connect()</code></strong>:<ul>
<li>Adds a new WebSocket to the specified channel.</li>
<li>If it's the first connection for a channel, it creates and starts a new data-fetching task for that channel.</li>
</ul>
</li>
<li><strong><code>disconnect()</code></strong>:<ul>
<li>Removes a WebSocket from a channel.</li>
<li>If a channel has no more active connections, it cancels the associated data-fetching task.</li>
</ul>
</li>
<li><strong><code>broadcast()</code></strong>: Sends a message (JSON) to all WebSockets connected to a specific channel.</li>
<li><strong><code>close()</code></strong>: Cleans up all connections and cancels all tasks, typically called during application shutdown.</li>
</ul>
<h3 id="72-redisconnectionmanager-srcconnectionsredis_connection_managerpy">7.2. <code>RedisConnectionManager</code> (<code>src/connections/redis_connection_manager.py</code>)<a class="headerlink" href="#72-redisconnectionmanager-srcconnectionsredis_connection_managerpy" title="Permanent link">&para;</a></h3>
<p>If Redis is configured (<code>REDIS_URL</code> is set), this manager is used to enable multi-instance WebSocket support.</p>
<ul>
<li><strong>Leverages Redis Pub/Sub</strong>:<ul>
<li><strong><code>active_connections</code></strong>: Similar to <code>ConnectionManager</code>, but stores local connections for the current instance.</li>
<li><strong><code>pubsub</code></strong>: A dictionary mapping channel names to Redis <code>PubSub</code> objects.</li>
<li><strong><code>listen_tasks</code></strong>: Tasks that listen for messages on Redis Pub/Sub channels.</li>
<li><strong><code>tasks</code></strong>: Data-fetching tasks, similar to <code>ConnectionManager</code>. One instance of the application will typically run the data fetching task for a given channel.</li>
</ul>
</li>
<li><strong><code>connect()</code></strong>:<ul>
<li>Subscribes the local WebSocket.</li>
<li>If not already listening, creates a <code>_listen_to_channel</code> task that subscribes to the Redis channel.</li>
<li>If no data-fetching task exists for this channel (across all instances, implicitly coordinated or by convention), it starts one.</li>
</ul>
</li>
<li><strong><code>disconnect()</code></strong>:<ul>
<li>Removes local WebSocket.</li>
<li>If no local connections remain for a channel, cancels the Redis listener task and the data-fetching task for that channel <em>on this instance</em>.</li>
<li>Unsubscribes from the Redis channel.</li>
</ul>
</li>
<li><strong><code>_listen_to_channel()</code></strong>: Continuously polls the Redis Pub/Sub channel for messages and uses <code>_broadcast()</code> to send them to locally connected WebSockets.</li>
<li><strong><code>_broadcast()</code></strong>: Sends messages to WebSockets connected to the channel <em>on the current instance</em>.</li>
<li><strong><code>publish()</code></strong>: Publishes a message to a Redis channel. The data-fetching task uses this method to send data, which is then picked up by <code>_listen_to_channel()</code> on all instances (including the publishing one) that have subscribers for that channel.</li>
<li><strong><code>close()</code></strong>: Cleans up local connections, tasks, and Redis Pub/Sub subscriptions.</li>
</ul>
<p>This architecture allows multiple instances of the application to share WebSocket load. A data-fetching task for a symbol might run on one instance, publish its data to Redis, and then all instances with clients interested in that symbol will receive the data via Redis Pub/Sub and forward it to their respective clients.</p>
<h2 id="8-rate-limiting-and-security-srcsecurity">8. Rate Limiting and Security (<code>src/security/</code>)<a class="headerlink" href="#8-rate-limiting-and-security-srcsecurity" title="Permanent link">&para;</a></h2>
<p>The application implements rate limiting and basic API key security.</p>
<h3 id="81-securityconfig-srcsecurityrate_limit_managerpy">8.1. <code>SecurityConfig</code> (<code>src/security/rate_limit_manager.py</code>)<a class="headerlink" href="#81-securityconfig-srcsecurityrate_limit_managerpy" title="Permanent link">&para;</a></h3>
<ul>
<li>Defines constants for security settings:<ul>
<li><code>ADMIN_API_KEY</code>: An API key that bypasses rate limits.</li>
<li><code>RATE_LIMIT</code>: Default requests per day for normal users.</li>
<li><code>HEALTH_CHECK_INTERVAL</code>: Cooldown period for the <code>/health</code> endpoint per IP.</li>
<li><code>OPEN_PATHS</code>: A set of paths (like <code>/docs</code>, <code>/ping</code>) that bypass all security checks.</li>
</ul>
</li>
</ul>
<h3 id="82-ratelimitmanager-srcsecurityrate_limit_managerpy">8.2. <code>RateLimitManager</code> (<code>src/security/rate_limit_manager.py</code>)<a class="headerlink" href="#82-ratelimitmanager-srcsecurityrate_limit_managerpy" title="Permanent link">&para;</a></h3>
<p>This class manages rate limit counts and health check access, stored in memory.</p>
<ul>
<li><strong>Storage</strong>: Uses dictionaries (<code>rate_limits</code>, <code>health_checks</code>) to store <code>RateLimitEntry</code> (count, expiration) and health check timestamps per IP.</li>
<li><strong><code>_clean_expired()</code></strong>: Periodically removes stale entries.</li>
<li><strong><code>get_rate_limit_info()</code></strong>: Returns current rate limit status for an IP (count, remaining, reset time).</li>
<li><strong><code>get_health_check_info()</code></strong>: Returns whether an IP can access <code>/health</code> and when the cooldown resets.</li>
<li><strong><code>check_health_rate_limit()</code></strong>: Enforces the cooldown for the <code>/health</code> endpoint. Admin key bypasses this.</li>
<li><strong><code>increment_and_check()</code></strong>: Increments the request count for an IP and checks if the limit is exceeded. Admin key bypasses this. Returns <code>(is_allowed, rate_limit_info)</code>.</li>
<li><strong><code>validate_websocket()</code></strong>: Checks rate limits for WebSocket connections. If exceeded, the connection is closed.</li>
<li><strong><code>cleanup()</code></strong>: Clears all stored rate limit data.</li>
</ul>
<h3 id="83-ratelimitmiddleware-srcsecurityrate_limit_middlewarepy">8.3. <code>RateLimitMiddleware</code> (<code>src/security/rate_limit_middleware.py</code>)<a class="headerlink" href="#83-ratelimitmiddleware-srcsecurityrate_limit_middlewarepy" title="Permanent link">&para;</a></h3>
<p>This FastAPI middleware enforces the rate limits.</p>
<ul>
<li><strong>Dispatch Logic</strong>:<ul>
<li>Skips security for paths in <code>SecurityConfig.OPEN_PATHS</code>.</li>
<li>For <code>/health</code> path: Uses <code>check_health_rate_limit</code>. If denied, returns 429. Otherwise, adds <code>X-RateLimit-Reset</code> header for health check cooldown.</li>
<li>For other paths: Uses <code>increment_and_check</code>. If denied, returns 429. Otherwise, adds <code>X-RateLimit-Limit</code>, <code>X-RateLimit-Remaining</code>, and <code>X-RateLimit-Reset</code> headers to the response.</li>
</ul>
</li>
<li><strong>API Key</strong>: Reads <code>x-api-key</code> header to identify admin users.</li>
<li><strong>Client IP</strong>: Uses <code>request.client.host</code> for rate limiting.</li>
</ul>
<p>This setup provides a basic but effective way to protect the API from abuse while allowing administrative access and open access to documentation.</p>
<h2 id="9-authentication-srcutilsyahoo_authpy">9. Authentication (<code>src/utils/yahoo_auth.py</code>)<a class="headerlink" href="#9-authentication-srcutilsyahoo_authpy" title="Permanent link">&para;</a></h2>
<p>Authentication with Yahoo Finance is crucial for accessing their unofficial API. The <code>YahooAuthManager</code> class handles this process:</p>
<ul>
<li><strong>Cookie and Crumb</strong>: Yahoo Finance API requests require a valid cookie and a "crumb" (a type of CSRF token).</li>
<li><strong><code>YahooAuthManager</code></strong>:<ul>
<li>Manages fetching and caching of the cookie and crumb.</li>
<li>A single instance is created at application startup and shared.</li>
<li>Uses an <code>asyncio.Lock</code> to prevent concurrent refresh attempts.</li>
<li><strong><code>refresh()</code> method</strong>: Fetches a new cookie/crumb pair. It first tries a direct crumb endpoint. If that fails (e.g., due to consent requirements), it navigates the Yahoo consent flow to obtain a CSRF token and session ID, then uses these to get a valid crumb.</li>
<li><strong><code>get_or_refresh()</code> method</strong>: Provides the cached cookie/crumb if still valid (within <code>_MIN_REFRESH_INTERVAL</code>), otherwise triggers a refresh. This is the primary method used by dependencies.</li>
</ul>
</li>
<li><strong>Error Handling</strong>: Raises <code>YahooAuthError</code> if it fails to obtain a valid cookie/crumb after attempting all methods.</li>
<li><strong>Integration</strong>: The <code>YahooAuth</code> dependency in <code>dependencies.py</code> uses <code>YahooAuthManager</code> to provide the auth details to <code>YahooFinanceClient</code>.</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.expand", "navigation.indexes", "content.code.copy", "content.code.annotate"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>