# 502 Bad Gateway 错误解决方案

## 问题说明

502错误表示Nginx无法连接到后端服务。这通常是因为：
1. 后端服务还未完全启动（需要30-60秒）
2. 后端服务启动失败
3. 网络配置问题

## 快速解决步骤

### 步骤1：运行诊断工具
```bash
./diagnose.sh
```

这会检查：
- Docker安装
- 容器状态
- 后端API响应
- 端口占用
- 网络配置

### 步骤2：查看后端日志
```bash
docker logs financequery-backend
```

查找错误信息。常见错误：
- `ModuleNotFoundError`: Python依赖缺失
- `Cython compilation failed`: 编译失败
- `Address already in use`: 端口冲突

### 步骤3：等待服务启动
首次启动需要更长时间（构建镜像、编译Cython等）：

```bash
# 等待60秒
sleep 60

# 测试后端
curl http://localhost:8000/ping
```

应该返回：
```json
{"status":"healthy","timestamp":"2025-10-09..."}
```

### 步骤4：检查服务状态
```bash
docker ps
```

应该看到3个容器都在运行：
- financequery-backend
- financequery-frontend
- financequery-nginx

### 步骤5：重启服务
如果服务没有正常运行：

```bash
docker compose down
docker compose up -d

# 等待启动
sleep 30

# 检查状态
docker ps
curl http://localhost:8000/ping
```

## 详细排查

### 后端无法启动

#### 原因1：Cython编译失败
**解决方法：**
```bash
# 重新构建，清除缓存
docker compose build --no-cache backend
docker compose up -d backend

# 查看构建日志
docker compose logs backend
```

#### 原因2：Python依赖问题
**解决方法：**
检查Dockerfile中的依赖安装是否成功：
```bash
docker exec -it financequery-backend pip list
```

#### 原因3：端口8000被占用
**检查：**
```bash
# Linux/Mac
lsof -i :8000

# 或
netstat -tuln | grep 8000
```

**解决：**修改 `docker-compose.yml`:
```yaml
backend:
  ports:
    - "8001:8000"  # 改用8001
```

### Redis错误

Redis是**完全可选的**。不要担心Redis错误！

后端代码会自动检查：
```python
if os.getenv("REDIS_URL"):
    # 使用Redis
else:
    # 使用内存管理器（默认）
```

**不需要配置Redis**，后端会正常运行。

### 网络问题

#### 检查Docker网络
```bash
docker network inspect financequery-network
```

应该看到3个容器都在这个网络中。

#### 重建网络
```bash
docker compose down
docker network prune
docker compose up -d
```

## 完全重置（最后手段）

如果所有方法都失败：

```bash
# 1. 停止并删除所有容器
docker compose down -v

# 2. 删除镜像
docker rmi financequery-backend financequery-frontend

# 3. 清理Docker系统
docker system prune -a

# 4. 重新构建（无缓存）
docker compose build --no-cache

# 5. 启动服务
docker compose up -d

# 6. 等待启动（重要！）
echo "等待服务启动..."
sleep 60

# 7. 测试后端
curl http://localhost:8000/ping

# 8. 查看状态
docker ps
docker compose logs
```

## 验证服务正常

### 后端健康检查
```bash
# 基本检查
curl http://localhost:8000/ping

# 完整健康检查
curl http://localhost:8000/health

# 获取市场指数
curl http://localhost:8000/v1/indices

# 获取股票报价
curl "http://localhost:8000/v1/quotes?symbols=AAPL"
```

### 前端访问
在浏览器打开：`http://localhost:8080`

应该看到：
- 市场指数
- 涨跌幅榜
- 板块表现
- 财经新闻

## 常用调试命令

```bash
# 查看所有容器
docker ps -a

# 实时日志
docker compose logs -f

# 查看特定容器日志
docker logs financequery-backend --tail=100

# 进入容器
docker exec -it financequery-backend bash

# 重启特定服务
docker compose restart backend

# 重启所有服务
docker compose restart

# 查看网络
docker network ls

# 查看容器详情
docker inspect financequery-backend
```

## 性能优化

### 增加启动等待时间
修改 `start.sh` 中的等待时间：
```bash
sleep 60  # 从10秒增加到60秒
```

### 分步启动
```bash
# 先启动后端
docker compose up -d backend
sleep 30

# 再启动前端
docker compose up -d frontend
sleep 10

# 最后启动Nginx
docker compose up -d nginx
```

## 需要帮助？

1. 运行诊断工具：`./diagnose.sh`
2. 查看完整日志：`docker compose logs > logs.txt`
3. 检查 `TROUBLESHOOTING.md` 获取更多信息
4. 确认所有配置文件正确

## 成功标志

当服务正常运行时：

```bash
$ docker ps
CONTAINER ID   IMAGE                    STATUS
abc123...      financequery-backend     Up 2 minutes
def456...      financequery-frontend    Up 2 minutes
ghi789...      nginx:alpine             Up 2 minutes

$ curl http://localhost:8000/ping
{"status":"healthy","timestamp":"..."}

$ curl http://localhost:8080
<!DOCTYPE html>...  # HTML内容
```

浏览器访问 `http://localhost:8080` 应该看到完整的股票数据界面！
